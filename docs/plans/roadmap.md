# 実装改善計画

この文書では、主要モジュールごとに今後の改善タスクと優先度を整理します。開発着手時は、各項目の背景と完了条件を確認してください。

## 優先度レベル
- **P0**: 直ちに対応が必要。既存機能に重大な影響を与えるもの。
- **P1**: 近い将来に対応する。ユーザー体験または保守性の向上につながるもの。
- **P2**: 余裕があるときに実施する。改善効果はあるが緊急性は高くないもの。

## main.py
- **P1**: `/ping` 以外のコマンド群についてもレスポンス計測結果を共通化するヘルパーを導入する。完了条件: `utils` または `services` に共通関数を追加し、既存コマンドの重複コードを削減する。【src/main.py†L119-L208】
- **P2**: 起動ログに Git コミット情報を含め、デプロイ確認を容易にする。完了条件: 起動時に環境変数 `GIT_SHA` を参照してログ出力する。

## FlowController と handlers
- **P0**: 未実装の TODO であるテンプレート削除フローの追加。完了条件: `AmidakujiState` に新しい状態を追加し、ビュー・ハンドラー・アクションが整合する。【src/main.py†L30-L32】【src/models/state_model.py†L1-L120】
- **P1**: ハンドラー間の重複ロジック（テンプレート検索やバリデーション）を共通ヘルパーに抽出。完了条件: `flow/handlers.py` の重複コードが 20 行以上削減される。【src/flow/handlers.py†L1-L400】

## データアクセス層
- **P1**: `HistoryRepository.fetch_recent` にページネーションとエラーハンドリングを追加。完了条件: 例外発生時に `CheckResult` に相当する構造で通知できるようにする。【src/db_manager.py†L86-L140】
- **P2**: Firestore のクエリ頻度を最適化するため、簡易キャッシュレイヤーを `DBManager` に導入。完了条件: `DBManager` に TTL 付きキャッシュが追加され、主要クエリがキャッシュ経由で実行可能になる。

## services
- **P1**: `load_firebase_credentials` が HTTP ダウンロードしたファイルをローカルにキャッシュするよう修正。完了条件: 連続起動時に再ダウンロードされないことを確認する。【src/services/app_context.py†L12-L27】
- **P2**: StartupSelfCheck の結果を Discord 管理チャンネルに送信する通知機能の実装。完了条件: エラー時に指定チャンネルへ埋め込みを送る処理が追加される。【src/services/startup_check.py†L14-L114】

## data_process.py
- **P1**: 重みテーブルが部分的に欠損している場合のフォールバック戦略を明文化。完了条件: 欠損値を検出した際に警告ログを出すよう改修し、テストが追加される。【src/data_process.py†L17-L90】
- **P2**: `create_embeds_from_pairs` にカスタムテンプレート（絵文字など）を適用する機構を導入。完了条件: `ResultEmbedMode` に新しいモードが追加され、ユニットテストが整備される。【src/data_process.py†L92-L152】

## ドキュメント
- **P0**: 今回整備した各カテゴリの文書を Pull Request テンプレートから参照できるよう README を更新。完了条件: README にカテゴリの役割と参照リンクが追記される。

---
計画の達成状況は定期的に見直し、完了した項目は履歴として別ドキュメントにまとめる予定です。
